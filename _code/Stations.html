<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
    <!-- loads variables stations and edges -->
    <script type="text/javascript" src="_data/stations.js"></script>
    <script type="text/javascript" src="_data/edges.js"></script>
    <script type="text/javascript" src="_js/helper.js"></script>
    <title>Stations.html</title>
</head>
<body>
<div id="viz"></div>
    
<script type="text/javascript">
var edge_wt=0;

//scales
var x = d3.scale.linear().domain([0, 25]).range([0, 400]);
var y = d3.scale.linear().domain([0, 25]).range([0, 600]);
var e = d3.scale.linear().domain([0, 4000]).range([0, 20]);

var svgContainer = d3.select("body").append("svg")
                                    .attr("width", 960)
                                    .attr("height", 620);

// add edges
var edges = svgContainer.selectAll("line")
						.data(edges)
						.enter()
						.append("line")
						.attr("x1", function (data) { return x(data.x1); })
						.attr("y1", function (data) { return y(data.y1); })
						.attr("x2", function (data) { return x(data.x2); })
						.attr("y2", function (data) { return y(data.y2); })
						.style("stroke", "rgb(6,120,155)")
						.style("stroke-width", 1)
						.style("stroke-opacity", 0.6);

// add stations
var circles = svgContainer.selectAll("circle")
                          .data(stations)
                          .enter()
                          .append("circle");

var circleAttributes = circles
                       .attr("cx", function (d) { return x(d.x_axis); })
                       .attr("cy", function (d) { return y(d.y_axis); })
                       .attr("r", function (d) { return d.radius; })
                       .style("fill", function(d) { return d.color; });

circles.on("mouseover", expandStationSize)
		.on("mouseout", returnStationSizeToNormal)
		.on("mousedown", sourceSelected);


function expandStationSize()
{
	d3.select(this).attr("r", 6)
	.style("fill", "black");
}

function returnStationSizeToNormal()
{
	d3.select(this).attr("r", 2)
	.style("fill", "black");
}


function sourceSelected()
{
	// This is where shit goes down!
	// Get source station
	current_element = d3.select(this);
	source_station_id = current_element.datum().st_id;
	
	//console.log(current_element.datum().st_id);

	/* Get data */
	// url localhost:27608/edges?datetime=jan2014&source=source_station_id
	// TODO: move to function
	edge_weight_file = "_data/edges/"+source_station_id+".json";
	//	console.log(edge_weight_file);
	d3.json(edge_weight_file, function(json, error)
	{
		if (error) return console.warn(error);
		window.edge_wt = json;
	//	  console.log(window.edge_wt);
	});
	
	/*
	// alternatively
	var myjson = '{"name": "flare","children": [{"name": "analytics","children": [{"name": "cluster","children": [{"name": "MergeEdge", "size": 10 }]}]}]}';
	
	// d3.json("/path/flare.json", function(json) { #delete this line
	
	    json = JSON.parse( myjson ); //add this line
	
	    //rendering logic here
	
	//} #delete this line
	*/
	
	/* TODO reload data */
	//console.log(window.edge_wt);
	animateMapEdgesWithData(window.edge_wt);
	/* TODO reload small multiples */
	
	/* TODO any clean up */
}


function loadEdgeWeightsForStation(station)
{
}

function loadTimeSeriesDataForStation(station)
{
}

function animateMapEdgesWithData(edge_weights)
{
	console.log("animateMapEdgesWithData called");

	//	console.log(edge_weights)
	 
	var edges = svgContainer.selectAll("line")
	.data(edge_weights);
	console.log(edges);

	edges.transition()
	.duration(300)
	.ease("quad")
	.style("stroke-width", function(data) { return e(data.weight); });
	
	/*
	// for looping transitions
	function animateFirstStep(){
	    d3.select(this)
	      .transition()
	        .delay(0)
	        .duration(1000)
	        .attr("r", 10)
	        .each("end", animateSecondStep);
	};
	
	function animateSecondStep(){
	    d3.select(this)
	      .transition()
	        .duration(1000)
	        .attr("r", 40);
	};
	
	*/
}

function reloadTimeSeriesWithData()
{
}

var coordinates = [0, 0];
function scrubbedToTime()
{
	// todo called when the user scrubs the time line
	// in the time series visualization
	coordinates = d3.mouse(this);
	var x = coordinates[0];
	var y = coordinates[1];
//	console.log(x);
	// TODO: these should not be hard coded
	// TODO: some of them can be made one time computations
	years = ['2006','2007','2008','2009','2010','2011','2012','2013'];
	n_years = years.length;
	months = range(1,13);
	n_months = 12;
	
	var time_scale = d3.scale.linear().domain([50, 910]).range([0, n_years*n_months]);
	x_time_scale = Math.floor(time_scale(x))
//	console.log(x_time_scale);
	selected_month = x_time_scale%n_months;
	selected_year = Math.floor(x_time_scale/n_months);
	console.log(years[selected_year]);
	console.log(months[selected_month]);
	// x-> 50 to 830
	
	// TODO: update map viz here
	
}

function destinationSelected()
{
	// todo called when the user selects the destination station
	// in the time series plot
}

function regionSelected()
{
	// todo region selected
}
</script>

<script src="_data/sample-ts.js"></script>
<script src="_js/time-series.js"></script>

</body>
</html>
